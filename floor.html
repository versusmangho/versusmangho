<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¸µìˆ˜ ì¸¡ì •ê¸°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Noto+Sans+KR:wght@300;500;700&display=swap');
        
        body {
            background: #0f172a;
            color: #f1f5f9;
            font-family: 'Noto Sans KR', sans-serif;
        }
        .header-font { font-family: 'Orbitron', sans-serif; }
        .track-row {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        .track-row:hover {
            border-color: #3b82f6;
            background: rgba(30, 41, 59, 1);
        }
        .floor-value {
            font-family: 'Orbitron', sans-serif;
            text-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }
        .loading-shimmer {
            background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        .track-row.highlight {
            border-color: #3b82f6 !important;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.6);
            transform: scale(1.02);
        }
        .track-row.played {
            background: rgba(34, 197, 94, 0.15);
            border-color: #22c55e !important;
            opacity: 0.8;
        }
        .track-row.played .status-played {
            display: inline-block;
        }
        .track-row.banned {
            background: rgba(239, 68, 68, 0.15);
            border-color: #ef4444 !important;
            opacity: 0.8;
        }
        .track-row.banned .status-banned {
            display: inline-block;
        }
        #screenshotContainer {
            margin-bottom: 2rem;
            display: none;
            justify-content: center;
        }
        #screenshotPreview {
            max-width: 300px;
            cursor: pointer;
            border-radius: 0.75rem;
            border: 2px solid #334155;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        #screenshotPreview.expanded {
            max-width: 100%;
            border-color: #3b82f6;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2);
        }
        /* Mode Toggle */
        .mode-toggle-container {
            position: absolute;
            top: 2rem;
            right: 2rem;
            display: flex;
            background: rgba(30, 41, 59, 0.8);
            padding: 4px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 50;
        }
        .mode-btn {
            padding: 6px 16px;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            transition: all 0.2s;
            cursor: pointer;
        }
        .mode-btn.active {
            background: #3b82f6;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .mode-btn:not(.active):hover {
            background: rgba(255, 255, 255, 0.05);
        }
        /* General Mode Grid */
        .general-grid {
            display: grid;
            grid-template-columns: auto repeat(4, 1fr);
            gap: 1px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        .grid-cell {
            background: #1e293b;
            padding: 12px 8px;
            text-align: center;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.85rem;
        }
        .grid-header {
            background: #334155;
            font-weight: bold;
            color: #94a3b8;
            font-size: 0.75rem;
        }
        .grid-row-label {
            background: #334155;
            font-weight: bold;
            color: #94a3b8;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 12px;
        }
        .grid-value {
            color: #3b82f6;
            font-weight: bold;
        }
        .grid-value.empty {
            color: #475569;
            font-weight: normal;
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <div class="mode-toggle-container">
        <div id="mode-versus" class="mode-btn active" onclick="setMode('versus')">ë²„ë§í˜¸ ëª¨ë“œ</div>
        <div id="mode-general" class="mode-btn" onclick="setMode('general')">ì¼ë§í˜¸ ëª¨ë“œ</div>
    </div>

    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-10">
            <h1 class="header-font text-4xl md:text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-indigo-500 mb-2">
                FLOOR METER
            </h1>
            <p class="text-gray-400 font-light uppercase tracking-widest text-sm">ì¸µìˆ˜ ì¸¡ì •ê¸° (v-archive ê¸°ë°˜)</p>
        </header>

        <!-- Main Interaction Area -->
        <div id="dropZone" class="mb-8 border-2 border-dashed border-slate-700 rounded-2xl p-8 text-center cursor-pointer hover:border-blue-500 transition-colors bg-slate-900/50">
            <p class="text-slate-400 mb-2">ìŠ¤í¬ë¦°ìƒ·ì„ ë³µì‚¬í•œ í›„ <kbd class="bg-slate-800 px-2 py-1 rounded text-white">Ctrl + V</kbd>ë¥¼ ëˆ„ë¥´ì„¸ìš”</p>
            <p class="text-xs text-slate-500">16:9 ë¹„ìœ¨ì˜ ìŠ¤í¬ë¦°ìƒ·ë§Œ ì¸ì‹í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        </div>

        <!-- Message Area -->
        <div id="messageZone" class="text-center text-yellow-400 mb-4 h-6"></div>

        <!-- Hash Upload Area (Hidden by default) -->
        <div id="hashUploadContainer" class="hidden mb-8 p-6 bg-slate-900/80 border border-yellow-500/30 rounded-2xl text-center">
            <p class="text-yellow-500 mb-4 text-sm font-bold">âš ï¸ í•´ì‹œ ë°ì´í„°(hashes.json)ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>
            <label class="bg-yellow-600 hover:bg-yellow-500 text-white px-4 py-2 rounded-lg cursor-pointer transition-colors inline-block font-bold text-sm">
                í•´ì‹œ íŒŒì¼ ì„ íƒ
                <input type="file" id="hashFileInput" class="hidden" accept=".json" onchange="handleHashUpload(this)">
            </label>
            <p class="text-slate-500 mt-2 text-xs">ë¡œì»¬ í™˜ê²½ì—ì„œëŠ” hashes.json íŒŒì¼ì„ ì§ì ‘ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.</p>
        </div>

        <!-- Screenshot Preview -->
        <div id="screenshotContainer">
            <img id="screenshotPreview" alt="Original Screenshot">
        </div>

        <!-- Result List -->
        <div id="resultList" class="space-y-4">
            <div class="text-center py-20 text-slate-600 italic">í˜ì´ì§€ ë¡œë”© ì¤‘...</div>
        </div>
    </div>
    
    <script>
        const resultList = document.getElementById('resultList');

        // --- ì„¤ì •ê°’ (2560x1440 ê¸°ì¤€ ë¹„ìœ¨) ---
        const BASE_W = 2560, BASE_H = 1440;
        const RATIO_X_START = 307 / BASE_W;
        const RATIO_THUMB_W = 240 / BASE_W;
        const RATIO_GAP = 186 / BASE_W;
        const RATIO_Y_START = 545 / BASE_H;
        const RATIO_THUMB_H = 240 / BASE_H;
        const RATIO_BAR_H = 43 / BASE_H;

        // --- ì¼ë§í˜¸ (General) ì„¤ì • ---
        const RATIO_GENERAL_X = 885 / BASE_W;
        const RATIO_GENERAL_Y = 711 / BASE_H;
        const RATIO_GENERAL_W = 80 / BASE_W;
        const RATIO_GENERAL_H = 80 / BASE_H;

        let currentMode = 'versus'; // 'versus' or 'general'

        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`mode-${mode}`).classList.add('active');
            
            // ì´ˆê¸°í™”
            resultList.innerHTML = `<div class="text-center py-20 text-slate-600 italic">ì¤€ë¹„ ì™„ë£Œ! ìŠ¤í¬ë¦°ìƒ·ì„ ë³µì‚¬í•œ ë’¤ Ctrl+Vë¡œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.</div>`;
            document.getElementById('screenshotContainer').style.display = 'none';
            document.getElementById('dropZone').style.display = 'block';
            lastImageHash = null;
        }

        const BAR_SPLIT = 0.5;
        const W_AHASH = 1.0;
        const W_DHASH = 1.0;

        // ë ˆí¼ëŸ°ìŠ¤ í•´ì‹œ ì €ì¥ì†Œ
        const thumbRefs = [];
        const buttonRefs = {};
        const diffRefs = {};

        // ê¸°ëŠ¥ ê°œì„ ì„ ìœ„í•œ ë³€ìˆ˜
        let isProcessing = false;
        let lastImageHash = null;
        const COOLDOWN_MS = 3000;

        // ------------------------------
        // Canvas ìœ í‹¸
        // ------------------------------
        function cropToCanvas(sourceImg, x, y, w, h) {
            const c = document.createElement('canvas');
            c.width = Math.max(1, Math.round(w));
            c.height = Math.max(1, Math.round(h));
            const ctx = c.getContext('2d', { willReadFrequently: true });
            ctx.drawImage(sourceImg, x, y, w, h, 0, 0, c.width, c.height);
            return c;
        }

        // ------------------------------
        // í•´ì‹œ êµ¬í˜„ (aHash / dHash / pHash)
        // ------------------------------
        function getGrayscaleFromCanvas(canvas, w, h) {
            const ctx = canvas.getContext('2d', { willReadFrequently: true });
            const data = ctx.getImageData(0, 0, w, h).data;
            const gray = new Float32Array(w * h);
            for (let i = 0, p = 0; i < data.length; i += 4, p++) {
                gray[p] = (data[i] + data[i + 1] + data[i + 2]) / 3.0;
            }
            return gray;
        }

        function aHashFromCanvas(canvas) {
            const w = 8, h = 8;
            const c = document.createElement('canvas');
            c.width = w; c.height = h;
            c.getContext('2d').drawImage(canvas, 0, 0, w, h);
            const gray = getGrayscaleFromCanvas(c, w, h);
            let avg = 0;
            for (let i = 0; i < gray.length; i++) avg += gray[i];
            avg /= gray.length;
            let hi = 0, lo = 0;
            for (let i = 0; i < 64; i++) {
                const bit = gray[i] >= avg ? 1 : 0;
                if (i < 32) hi = (hi << 1) | bit;
                else lo = (lo << 1) | bit;
            }
            return { hi, lo };
        }

        function dHashFromCanvas(canvas) {
            const w = 9, h = 8;
            const c = document.createElement('canvas');
            c.width = w; c.height = h;
            c.getContext('2d').drawImage(canvas, 0, 0, w, h);
            const gray = getGrayscaleFromCanvas(c, w, h);
            let hi = 0, lo = 0;
            let bitIndex = 0;
            for (let y = 0; y < 8; y++) {
                for (let x = 0; x < 8; x++) {
                    const left = gray[y * 9 + x];
                    const right = gray[y * 9 + x + 1];
                    const bit = left < right ? 1 : 0;
                    if (bitIndex < 32) hi = (hi << 1) | bit;
                    else lo = (lo << 1) | bit;
                    bitIndex++;
                }
            }
            return { hi, lo };
        }

        function popcnt32(v) {
            v = v - ((v >>> 1) & 0x55555555);
            v = (v & 0x33333333) + ((v >>> 2) & 0x33333333);
            return (((v + (v >>> 4)) & 0x0F0F0F0F) * 0x01010101) >>> 24;
        }

        function ham64(a, b) {
            if (!a || !b) return Infinity;
            return popcnt32((a.hi ^ b.hi) >>> 0) + popcnt32((a.lo ^ b.lo) >>> 0);
        }

        function dct1D(vec, N) {
            const out = new Float32Array(N);
            const factor = Math.PI / N;
            for (let u = 0; u < N; u++) {
                let sum = 0;
                for (let x = 0; x < N; x++) {
                    sum += vec[x] * Math.cos((x + 0.5) * u * factor);
                }
                const c = (u === 0) ? Math.sqrt(1 / N) : Math.sqrt(2 / N);
                out[u] = c * sum;
            }
            return out;
        }

        function pHashFromCanvas(canvas) {
            const N = 32;
            const c = document.createElement('canvas');
            c.width = N; c.height = N;
            c.getContext('2d').drawImage(canvas, 0, 0, N, N);
            const gray = getGrayscaleFromCanvas(c, N, N);
            const tmp = new Array(N);
            for (let y = 0; y < N; y++) {
                const row = new Float32Array(N);
                for (let x = 0; x < N; x++) row[x] = gray[y * N + x];
                tmp[y] = dct1D(row, N);
            }
            const dct = new Array(N);
            for (let x = 0; x < N; x++) {
                const col = new Float32Array(N);
                for (let y = 0; y < N; y++) col[y] = tmp[y][x];
                const colD = dct1D(col, N);
                for (let y = 0; y < N; y++) {
                    if (!dct[y]) dct[y] = new Float32Array(N);
                    dct[y][x] = colD[y];
                }
            }
            const vals = [];
            for (let y = 0; y < 8; y++) {
                for (let x = 0; x < 8; x++) {
                    if (x === 0 && y === 0) continue;
                    vals.push(dct[y][x]);
                }
            }
            const sorted = vals.slice().sort((a, b) => a - b);
            const med = sorted[Math.floor(sorted.length / 2)];
            let hi = 0, lo = 0;
            let i = 0;
            for (let y = 0; y < 8; y++) {
                for (let x = 0; x < 8; x++) {
                    if (x === 0 && y === 0) continue;
                    const bit = dct[y][x] > med ? 1 : 0;
                    if (i < 32) hi = (hi << 1) | bit;
                    else lo = (lo << 1) | bit;
                    i++;
                }
            }
            if (i < 64) {
                const pad = 64 - i;
                if (pad <= 32) lo = (lo << pad) >>> 0;
                else { hi = (hi << (pad - 32)) >>> 0; lo = 0; }
            }
            return { hi: hi >>> 0, lo: lo >>> 0 };
        }

        // ------------------------------
        // ë ˆí¼ëŸ°ìŠ¤ ë¡œë“œ (hashes.json)
        // ------------------------------
        async function loadHashes() {
            try {
                const response = await fetch('hashes.json');
                if (!response.ok) {
                    throw new Error(`hashes.json ë¡œë”© ì‹¤íŒ¨: ${response.statusText}`);
                }
                const data = await response.json();
                Object.assign(buttonRefs, data.trackinfo.buttons);
                Object.assign(diffRefs, data.trackinfo.diffs);
                thumbRefs.push(...data.thumbnails);
            } catch (error) {
                console.error("í•´ì‹œ ë°ì´í„° ë¡œë”© ì˜¤ë¥˜:", error);
                document.getElementById('hashUploadContainer').classList.remove('hidden');
                resultList.innerHTML = `<div class="text-center py-20 text-yellow-500">ë°ì´í„° ë¡œë”©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìœ„ ë²„íŠ¼ì„ í†µí•´ hashes.json íŒŒì¼ì„ ìˆ˜ë™ìœ¼ë¡œ ì„ íƒí•´ì£¼ì„¸ìš”.</div>`;
            }
        }

        function handleHashUpload(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            resultList.innerHTML = `<div class="text-center py-20 text-slate-600 italic">ë°ì´í„° ì²˜ë¦¬ ì¤‘...</div>`;
            
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    Object.assign(buttonRefs, data.trackinfo.buttons);
                    Object.assign(diffRefs, data.trackinfo.diffs);
                    thumbRefs.length = 0;
                    thumbRefs.push(...data.thumbnails);
                    
                    document.getElementById('hashUploadContainer').classList.add('hidden');
                    resultList.innerHTML = `<div class="text-center py-20 text-slate-600 italic">ì¤€ë¹„ ì™„ë£Œ! ìŠ¤í¬ë¦°ìƒ·ì„ ë³µì‚¬í•œ ë’¤ Ctrl+Vë¡œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.</div>`;
                    console.log("ìˆ˜ë™ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:", { thumbnails: thumbRefs.length, buttons: Object.keys(buttonRefs).length, diffs: Object.keys(diffRefs).length });
                } catch (err) {
                    console.error("íŒŒì¼ í•´ì„ ì˜¤ë¥˜:", err);
                    alert("ì˜¬ë°”ë¥¸ JSON í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.");
                }
            };
            reader.readAsText(file);
        }

        async function init() {
            resultList.innerHTML = `<div class="text-center py-20 text-slate-600 italic">ë ˆí¼ëŸ°ìŠ¤ ë°ì´í„° ë¡œë”© ì¤‘...</div>`;
            await loadHashes();
            resultList.innerHTML = `<div class="text-center py-20 text-slate-600 italic">ì¤€ë¹„ ì™„ë£Œ! ìŠ¤í¬ë¦°ìƒ·ì„ ë³µì‚¬í•œ ë’¤ Ctrl+Vë¡œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.</div>`;
            console.log("ë ˆí¼ëŸ°ìŠ¤ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:", { thumbnails: thumbRefs.length, buttons: Object.keys(buttonRefs).length, diffs: Object.keys(diffRefs).length });
        }

        // ------------------------------
        // ë§¤ì¹­ ë¡œì§
        // ------------------------------
        function bestMatchThumbnail(hashA, hashD) {
            let best = { id: null, score: Infinity };
            for (const ref of thumbRefs) {
                const dA = ham64(hashA, ref.ah);
                const dD = ham64(hashD, ref.dh);
                const score = dA * W_AHASH + dD * W_DHASH;
                if (score < best.score) best = { id: ref.id, score };
            }
            return best;
        }

        function getSortedMatches(hashA, hashD) {
            return thumbRefs.map(ref => {
                const dA = ham64(hashA, ref.ah);
                const dD = ham64(hashD, ref.dh);
                return { id: ref.id, score: dA * W_AHASH + dD * W_DHASH };
            }).sort((a, b) => a.score - b.score);
        }

        function bestMatchPhash(targetPh, refMap) {
            let best = { key: null, dist: Infinity };
            for (const key of Object.keys(refMap)) {
                const dist = ham64(targetPh, refMap[key].ph);
                if (dist < best.dist) best = { key, dist };
            }
            return best;
        }

        // ------------------------------
        // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë° ë©”ì¸ ë¡œì§
        // ------------------------------
        function showTemporaryMessage(message, duration = 2500) {
            const msgZone = document.getElementById('messageZone');
            if (!msgZone) return;
            msgZone.textContent = message;
            setTimeout(() => {
                if (msgZone.textContent === message) {
                    msgZone.textContent = '';
                }
            }, duration);
        }
        
        window.addEventListener('paste', async (e) => {
            const now = Date.now();
            if (isProcessing) {
                showTemporaryMessage("ë¶„ì„ì´ ì´ë¯¸ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤.");
                return;
            }
            if (now - (window.lastProcessTime || 0) < COOLDOWN_MS) {
                const remaining = ((window.lastProcessTime + COOLDOWN_MS) - now) / 1000;
                showTemporaryMessage(`ì¿¨ë‹¤ìš´ ì¤‘ì…ë‹ˆë‹¤. ${remaining.toFixed(1)}ì´ˆ í›„ì— ì‹œë„í•˜ì„¸ìš”.`);
                return;
            }

            const items = e.clipboardData.items;
            for (let item of items) {
                if (item.type.indexOf('image') !== -1) {
                    const blob = item.getAsFile();
                    const img = new Image();
                    img.src = URL.createObjectURL(blob);
                    img.onload = () => {
                        const previewImg = document.getElementById('screenshotPreview');
                        const previewContainer = document.getElementById('screenshotContainer');
                        const dropZone = document.getElementById('dropZone');
                        
                        if (dropZone) dropZone.style.display = 'none';
                        
                        if (previewImg && previewContainer) {
                            previewImg.src = img.src;
                            previewImg.classList.remove('expanded');
                            previewContainer.style.display = 'flex';
                        }

                        const fullImageCanvas = document.createElement('canvas');
                        fullImageCanvas.width = img.width;
                        fullImageCanvas.height = img.height;
                        fullImageCanvas.getContext('2d').drawImage(img, 0, 0);

                        const currentHash = dHashFromCanvas(fullImageCanvas);
                        if (lastImageHash && ham64(lastImageHash, currentHash) === 0) {
                            showTemporaryMessage("ì´ì „ê³¼ ë™ì¼í•œ ì´ë¯¸ì§€ì…ë‹ˆë‹¤.");
                            return;
                        }
                        
                        isProcessing = true;
                        lastImageHash = currentHash;
                        window.lastProcessTime = Date.now();

                        processImage(img).finally(() => {
                            isProcessing = false;
                        });
                    };
                }
            }
        });

        async function processImage(img) {
            resultList.innerHTML = '';
            const W = img.width;
            const H = img.height;

            if (currentMode === 'versus') {
                for (let i = 0; i < 5; i++) {
                    const row = createLoadingRow(i + 1);
                    resultList.appendChild(row);

                    const x = (RATIO_X_START + (RATIO_THUMB_W + RATIO_GAP) * i) * W;
                    const y = RATIO_Y_START * H;
                    const tw = RATIO_THUMB_W * W;
                    const th = RATIO_THUMB_H * H;
                    const by = (RATIO_Y_START + RATIO_THUMB_H) * H;
                    const bh = RATIO_BAR_H * H;

                    const thumbCanvas = cropToCanvas(img, x, y, tw, th);
                    const ah = aHashFromCanvas(thumbCanvas);
                    const dh = dHashFromCanvas(thumbCanvas);
                    
                    const barCanvas = cropToCanvas(img, x, by, tw, bh);
                    const leftCanvas = cropToCanvas(barCanvas, 0, 0, barCanvas.width * BAR_SPLIT, barCanvas.height);
                    const rightCanvas = cropToCanvas(barCanvas, leftCanvas.width, 0, barCanvas.width * (1 - BAR_SPLIT), barCanvas.height);

                    row.matches = getSortedMatches(ah, dh);
                    row.matchIndex = 0;
                    row.btnPh = pHashFromCanvas(leftCanvas);
                    row.diffPh = pHashFromCanvas(rightCanvas);

                    await displayMatch(row, 0);
                }
            } else {
                // ì¼ë§í˜¸ ëª¨ë“œ (80x80 ë‹¨ì¼ ì¸ì‹)
                const row = createLoadingRow(1);
                resultList.appendChild(row);

                const x = RATIO_GENERAL_X * W;
                const y = RATIO_GENERAL_Y * H;
                const tw = RATIO_GENERAL_W * W;
                const th = RATIO_GENERAL_H * H;

                const thumbCanvas = cropToCanvas(img, x, y, tw, th);
                const ah = aHashFromCanvas(thumbCanvas);
                const dh = dHashFromCanvas(thumbCanvas);

                const matches = getSortedMatches(ah, dh);
                const best = matches[0];

                try {
                    const response = await fetchWithRetry(`https://v-archive.net/api/archive/DEV/title/${best.id}`);
                    const data = await response.json();
                    if (data && data.success) {
                        row.matches = matches;
                        row.matchIndex = 0;
                        updateGeneralRow(row, data, best.id);
                    }
                } catch (err) {
                    console.error(err);
                }
            }
        }

        async function displayGeneralMatch(row, index) {
            const match = row.matches[index];
            try {
                const response = await fetchWithRetry(`https://v-archive.net/api/archive/DEV/title/${match.id}`);
                const data = await response.json();
                if (data && data.success) {
                    updateGeneralRow(row, data, match.id);
                }
            } catch (err) {
                console.error(err);
            }
        }

        function updateGeneralRow(row, data, titleId) {
            row.className = 'track-row p-6 rounded-xl block opacity-100 shadow-lg relative';
            const btnList = ['4B', '5B', '6B', '8B'];
            const diffList = ['NM', 'HD', 'MX', 'SC'];

            let gridHtml = `
                <div class="general-grid mt-4">
                    <div class="grid-cell grid-header"></div>
                    ${diffList.map(d => `<div class="grid-cell grid-header">${d}</div>`).join('')}
            `;

            btnList.forEach(btn => {
                gridHtml += `<div class="grid-cell grid-row-label">${btn}</div>`;
                diffList.forEach(diff => {
                    const score = data.patterns?.[btn]?.[diff]?.floor || '-';
                    const style = getFloorStyle(score);
                    gridHtml += `<div class="grid-cell ${score==='-'?'empty':'grid-value'}" style="${score==='-'?'':style}">${score}</div>`;
                });
            });
            gridHtml += `</div>`;

            row.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center space-x-6">
                        <img src="https://v-archive.net/static/images/jackets/${titleId}.jpg" class="w-24 h-24 rounded-lg object-cover border-2 border-slate-700">
                        <div>
                            <h3 class="font-bold text-white text-2xl mb-1">${data.name}</h3>
                            <div class="flex items-center space-x-3">
                                <p class="text-slate-400 text-sm">ê³¡ ID: ${titleId}</p>
                                <button class="recheck-btn bg-slate-700 hover:bg-slate-600 text-white text-[10px] px-2 py-0.5 rounded transition-colors" onclick="event.stopPropagation(); handleRecheck(this)">ì¬ê²€í† </button>
                            </div>
                        </div>
                    </div>
                </div>
                ${gridHtml}
            `;
        }

        async function displayMatch(row, index) {
            const match = row.matches[index];
            const btnMatch = bestMatchPhash(row.btnPh, buttonRefs);
            const diffMatch = bestMatchPhash(row.diffPh, diffRefs);
            const button = btnMatch.key || "4B";
            const difficulty = diffMatch.key || "SC";

            try {
                const titleId = match.id;
                const response = await fetchWithRetry(`https://v-archive.net/api/archive/DEV/title/${titleId}`);
                const data = await response.json();

                if (data && data.success) {
                    row.apiData = data; // ë°ì´í„° ì €ì¥
                    const patternData = data.patterns?.[button]?.[difficulty];
                    updateRow(row, {
                        titleId,
                        name: data.name ?? `ID ${titleId}`,
                        button,
                        difficulty,
                        floor: patternData?.floor || "NO DATA",
                        rating: patternData?.rating || "-",
                        thumbScore: match.score
                    });
                } else {
                    updateRow(row, { titleId, name: `ID ${titleId} (API ì‹¤íŒ¨)`, button, difficulty, floor: "NO DATA", rating: "-", thumbScore: match.score });
                }
            } catch (err) {
                updateRow(row, { titleId: match.id, name: `ID ${match.id} (API ì˜¤ë¥˜)`, button, difficulty, floor: "NO DATA", rating: "-", thumbScore: match.score });
            }
        }

        function handleCorrection(el) {
            const row = el.closest('.track-row');
            if (!row || !row.apiData) return;
            
            const btnSelect = row.querySelector('.btn-select');
            const diffSelect = row.querySelector('.diff-select');
            const button = btnSelect.value;
            const difficulty = diffSelect.value;
            
            updateSelectColors(btnSelect, diffSelect);
            
            const patternData = row.apiData.patterns?.[button]?.[difficulty];
            const floorEl = row.querySelector('.floor-value');
            if (floorEl) {
                const floorVal = patternData?.floor || "NO DATA";
                floorEl.innerText = floorVal;
                floorEl.setAttribute('style', getFloorStyle(floorVal));
            }
        }

        function updateSelectColors(btnEl, diffEl) {
            const btnColors = { '4B': 'bg-green-600', '5B': 'bg-sky-600', '6B': 'bg-orange-600', '8B': 'bg-indigo-600' };
            const diffColors = { 'SC': 'bg-purple-600', 'MX': 'bg-red-600', 'HD': 'bg-orange-600', 'NM': 'bg-yellow-600' };
            
            [...Object.values(btnColors), ...Object.values(diffColors)].forEach(c => {
                btnEl.classList.remove(c);
                diffEl.classList.remove(c);
            });
            
            if (btnColors[btnEl.value]) btnEl.classList.add(btnColors[btnEl.value]);
            if (diffColors[diffEl.value]) diffEl.classList.add(diffColors[diffEl.value]);
        }

        function getFloorStyle(floorStr) {
            const floorNum = parseFloat(floorStr);
            if (isNaN(floorNum)) return 'color: #60a5fa';
            const floor = Math.floor(floorNum);
            if (floor >= 16) return 'color: #c084fc';
            // 1ì¸µ(íŒŒë‘, 240) -> 15ì¸µ(ë¹¨ê°•, 0)
            const hue = Math.max(0, 240 - (Math.max(1, floor) - 1) * (240 / 14));
            return `color: hsl(${hue}, 100%, 70%)`;
        }

        async function copyTrackInfo(btn, name) {
            const row = btn.closest('.track-row');
            const button = row.querySelector('.btn-select').value;
            const difficulty = row.querySelector('.diff-select').value;
            const floor = row.querySelector('.floor-value').innerText;
            const text = `${name} ${button} ${difficulty} (${floor})`;
            
            try {
                await navigator.clipboard.writeText(text);
                const originalInner = btn.innerHTML;
                btn.innerHTML = 'âœ…';
                setTimeout(() => { btn.innerHTML = originalInner; }, 1500);
            } catch (err) {
                console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
            }
        }

        async function handleRecheck(btn) {
            const row = btn.closest('.track-row');
            if (!row || !row.matches) return;
            
            row.matchIndex = (row.matchIndex + 1) % Math.min(row.matches.length, 10);
            btn.innerText = "ê²€ìƒ‰ ì¤‘...";
            btn.disabled = true;
            
            // ìƒíƒœ ì´ˆê¸°í™”
            row.classList.remove('played', 'banned');
            
            if (currentMode === 'general') {
                await displayGeneralMatch(row, row.matchIndex);
            } else {
                await displayMatch(row, row.matchIndex);
            }
        }

        async function fetchWithRetry(url, options = {}, retries = 3, backoff = 500) {
            for (let i = 0; i < retries; i++) {
                try {
                    const res = await fetch(url, options);
                    if (res.ok) return res;
                } catch (err) {
                    if (i === retries - 1) throw err;
                }
                await new Promise(r => setTimeout(r, backoff * Math.pow(2, i)));
            }
            throw new Error(`Failed to fetch ${url} after ${retries} attempts`);
        }
        
        // ------------------------------
        // UI ë Œë”ë§
        // ------------------------------
        function createLoadingRow(index) {
            const div = document.createElement('div');
            div.className = 'track-row p-4 rounded-xl flex items-center justify-between opacity-50';
            div.innerHTML = `
                <div class="flex items-center space-x-4 w-full">
                    <div class="w-20 h-20 rounded-lg bg-slate-800 loading-shimmer"></div>
                    <div class="flex-grow">
                        <div class="h-5 w-3/4 bg-slate-800 mb-2 loading-shimmer rounded"></div>
                        <div class="h-4 w-1/2 bg-slate-800 loading-shimmer rounded"></div>
                    </div>
                    <div class="text-right">
                        <div class="h-8 w-20 bg-slate-800 loading-shimmer rounded"></div>
                    </div>
                </div>
            `;
            return div;
        }

        function updateRow(row, info) {
            row.className = 'track-row p-4 rounded-xl flex items-center justify-between opacity-100 shadow-lg relative';
            const btnList = ['4B', '5B', '6B', '8B'];
            const diffList = ['NM', 'HD', 'MX', 'SC'];

            row.innerHTML = `
                <div class="flex items-center space-x-4">
                    <img src="https://v-archive.net/static/images/jackets/${info.titleId}.jpg" onerror="this.src='https://placehold.co/240x240/1e293b/white?text=No+Img'" class="w-20 h-20 rounded-lg object-cover border border-slate-700">
                    <div>
                        <h3 class="font-bold text-white text-lg">${info.name}</h3>
                        <div class="flex items-center space-x-1">
                            <select class="btn-select px-1 py-0.5 rounded text-[10px] font-bold header-font text-white border-none outline-none cursor-pointer appearance-none" onchange="event.stopPropagation(); handleCorrection(this)">
                                ${btnList.map(b => `<option value="${b}" ${b===info.button?'selected':''}>${b}</option>`).join('')}
                            </select>
                            <select class="diff-select px-1 py-0.5 rounded text-[10px] font-bold header-font text-white border-none outline-none cursor-pointer appearance-none" onchange="event.stopPropagation(); handleCorrection(this)">
                                ${diffList.map(d => `<option value="${d}" ${d===info.difficulty?'selected':''}>${d}</option>`).join('')}
                            </select>
                            <button class="recheck-btn ml-2 bg-slate-700 hover:bg-slate-600 text-white text-[10px] px-2 py-0.5 rounded transition-colors" onclick="event.stopPropagation(); handleRecheck(this)">ì¬ê²€í† </button>
                            <span class="status-tag status-played hidden ml-2 text-[10px] font-bold text-green-500 border border-green-500 px-1 py-0.5 rounded">PLAYED</span>
                            <span class="status-tag status-banned hidden ml-2 text-[10px] font-bold text-red-500 border border-red-500 px-1 py-0.5 rounded">BAN</span>
                        </div>
                    </div>
                </div>
                <div class="text-right flex flex-col items-end">
                    <button class="mb-1 text-slate-500 hover:text-blue-400 transition-colors" onclick="event.stopPropagation(); copyTrackInfo(this, '${info.name.replace(/'/g, "\\'")}')" title="ì •ë³´ ë³µì‚¬">
                        ğŸ“‹
                    </button>
                    <p class="text-xs text-slate-500 uppercase font-bold tracking-tighter">Floor</p>
                    <p class="floor-value text-3xl font-black" style="${getFloorStyle(info.floor)}">${info.floor}</p>
                </div>
            `;
            updateSelectColors(row.querySelector('.btn-select'), row.querySelector('.diff-select'));
        }

        function getButtonColor(button) {
            switch(button) {
                case '4B': return 'bg-green-600';
                case '5B': return 'bg-sky-600';
                case '6B': return 'bg-orange-600';
                case '8B': return 'bg-indigo-600';
                default: return 'bg-slate-600';
            }
        }

        function getDiffColor(diff) {
            switch(diff) {
                case 'SC': return 'bg-purple-600';
                case 'MX': return 'bg-red-600';
                case 'HD': return 'bg-orange-600';
                case 'NM': return 'bg-yellow-600';
                default: return 'bg-slate-600';
            }
        }

        // Left Click (Toggle Played)
        resultList.addEventListener('click', (e) => {
            const clickedRow = e.target.closest('.track-row');
            if (!clickedRow) return;
            clickedRow.classList.toggle('played');
            clickedRow.classList.remove('banned');
        });

        // Right Click (Toggle Ban/Pick)
        resultList.addEventListener('contextmenu', (e) => {
            const clickedRow = e.target.closest('.track-row');
            if (!clickedRow) return;
            e.preventDefault();
            clickedRow.classList.toggle('banned');
            clickedRow.classList.remove('played');
        });

        // Screenshot Toggle
        document.getElementById('screenshotPreview')?.addEventListener('click', function() {
            this.classList.toggle('expanded');
        });

        window.onload = init;
    </script>
</body>
</html>